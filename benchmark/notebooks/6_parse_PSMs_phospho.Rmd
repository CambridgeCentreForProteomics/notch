---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

Load libraries
```{r setup, message=FALSE}

#### Load packages ####
library(camprotR)
library(ggplot2)
library(tidyverse)
library(MSnbase)
```

Make the cRAP list for filtering
```{r}
get_fasta_ids <- function(fasta){
  # Load the FASTA 
  bs.fasta <- Biostrings::fasta.index(fasta, seqtype = "AA")
  
  # Extract the UniProt accessions 
  accessions <- bs.fasta %>% 
    pull(desc) %>% 
    stringr::str_extract_all("(?<=\\|).*?(?=\\|)") %>% 
    unlist()

  accessions
}

crap.accessions <- get_fasta_ids('../shared_files/cRAP_FullIdentifiers.fasta')


```

Match species to uniprotID
```{r}
hs.accessions <- get_fasta_ids(
  '../shared_files/CCP_SwissProt_homo_sapiens_proteome_without_isoforms_20180409.fasta')
sc.accessions <- get_fasta_ids(
  '../shared_files/swissprot_yeast_database_june2020.fasta')

uniprot_2_species <- data.frame('id'=c(hs.accessions, sc.accessions),
                                'species'=c(rep('H.sapiens', length(hs.accessions)),
                                            rep('S.cerevisiae', length(sc.accessions))))
head(uniprot_2_species)
```

```{r}
phospho_psm <- parse_features(read.delim('../raw/phospho_proteome_PSMs.txt.gz'), crap_proteins=crap.accessions)
```
Parse the PTM scores, add filtered_* columns to detail filtering.
```{r}
phospho_psm <- parse_PTM_scores(phospho_psm, ptm_col="PhosphoRS.Best.Site.Probabilities", threshold=75)
phospho_psm_filtered <- phospho_psm %>% filter(filtered_score!="") # The filtering doesn't actually take place until this step 
```
Add the position of the phosphorylation and the sequence around the site (useful for integrating with external databases)
```{r}
protein_fasta_inf <- '../shared_files/combined_species.fasta'

phospho_psm_filtered <- phospho_psm_filtered %>% add_PTM_positions(protein_fasta_inf)
phospho_psm_filtered <- add_site_sequence(phospho_psm_filtered, protein_fasta_inf)

```

Add the positions of the peptides

```{r}
phospho_psm_filtered <- phospho_psm_filtered %>% add_peptide_positions(protein_fasta_inf)
```

```{r}
species_matches <- phospho_psm_filtered %>% select(Protein.Accessions) %>%
mutate(Protein.Accessions_sep=Protein.Accessions) %>%
separate_rows(Protein.Accessions_sep) %>%
merge(uniprot_2_species, by.x='Protein.Accessions_sep', by.y='id', all.x=TRUE) %>%
group_by(Protein.Accessions) %>%
summarise(all_species=paste0(unique(species), collapse='; ')) %>%
mutate(species=ifelse(grepl(';', all_species), 'mixed', all_species))

phospho_psm_filtered <- phospho_psm_filtered %>% merge(species_matches, by='Protein.Accessions')
```

```{r}
sample_info <- read.delim('../raw/sample_info_phospho.tsv') %>% tibble::column_to_rownames('tag')

abundance_cols <- colnames(phospho_psm_filtered)[
  grepl('Abundance.', colnames(phospho_psm_filtered))]

phospho_e <- as.matrix(phospho_psm_filtered[,abundance_cols])
phospho_f <- phospho_psm_filtered[,setdiff(colnames(phospho_psm_filtered), abundance_cols)]

  
# update the column names to remove the 'Abundance.` prefix
colnames(phospho_e) <- gsub('Abundance.', '', colnames(phospho_e))

phospho_res <- MSnbase::MSnSet(exprs=phospho_e, fData=phospho_f, pData=sample_info)

dim(phospho_res)
```

```{r}
phospho_res %>% plot_missing_SN(bins=30)
phospho_res %>% plot_missing_SN_per_sample(bins=30)
phospho_res %>% plot_TMT_notch()
phospho_res %>% plot_TMT_notch(facet_by_sample=TRUE)
```
```{r}
source('./R/get_quant_vs_mean.R')

quant_vs_mean_phospho <- phospho_res %>% get_quant_vs_mean()
```


```{r}
exp_design <- pData(phospho_res) %>%
  select(condition, S.cerevisiae=yeast, H.sapiens=human) %>%
  unique()
  
sc_spikes <- exp_design$S.cerevisiae
hs_spikes <- exp_design$H.sapiens

get_ground_truth <- function(sc_spikes, hs_spikes, ix_1, ix_2){
  comparison <- sprintf('%s vs %s', sc_spikes[ix_2], sc_spikes[ix_1])
  hs_ground_truth <- hs_spikes[ix_2]/hs_spikes[ix_1]
  sc_ground_truth <- sc_spikes[ix_2]/sc_spikes[ix_1]
  return(c(comparison, hs_ground_truth, sc_ground_truth))
}

library(gtools)

expected <- apply(permutations(n=3,r=2), 1, function(x){
  get_ground_truth(sc_spikes, hs_spikes, x[1], x[2])
}) %>% t() %>% data.frame() %>%
  setNames(c('comparison', 'H.sapiens', 'S.cerevisiae')) %>%
  mutate_at(vars(S.cerevisiae, 
                 H.sapiens), 
            funs(as.numeric)) %>%
  pivot_longer(-comparison, names_to='species', values_to='expected')

print(expected)

positive_comparisons <- expected %>% filter(species=='S.cerevisiae', expected>1) %>%
  pull(comparison)
```
```{r}
quant_vs_mean_phospho %>%
    ggplot(aes(log2(intensity), diff)) +
    geom_point(size=0.2, alpha=0.2, colour='grey20') +
    theme_camprot(base_size=12) +
    facet_grid(species~comparison, scales='free_y') +
    geom_hline(aes(yintercept=log2(expected)),
               data=expected,
               colour='black', linetype=2) +
    xlab('Tag intensity (log2)') +
    ylab('Difference in intensity (log2)') +
    scale_colour_manual(values=c(get_cat_palette(7)),
                        name='Isolation interference (%)')
```

```{r}
ptm_pep_group <- paste(fData(phospho_res)$Sequence,
                       fData(phospho_res)$ptm_position, sep=': ')
print(length(ptm_pep_group))
print(length(unique(ptm_pep_group)))

phospho_peptide <- MSnbase::combineFeatures(phospho_res, groupBy=ptm_pep_group, method='sum')
```