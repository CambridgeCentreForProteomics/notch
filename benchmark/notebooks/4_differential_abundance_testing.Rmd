---
title: 'Aggregate to protein-level abundances'
author:
  - name: "Tom Smith"
    affiliation: "Cambridge Centre for Proteomics"
date: "`r format(Sys.time(), '%d %B, %Y')`"
abstract: | 
  Here, we use limma to perform differential protein abundance testing and then
  compare the results with the different filtering thresholds.
output:
  pdf_document:
  html_notebook: default
geometry: margin=1in
fontfamily: mathpazo
fontsize: 11pt
---

```{r}
library(camprotR)
library(tidyverse)
library(limma)
library(DEqMS)
library(MSnbase)
```


```{r}
prot_res <- readRDS('../results/prot_res.rds')
pep_res <- readRDS('../results/prot_res.rds')
expected <- readRDS('../results/expected.rds')
psm_res <- readRDS('../results/psm_res.rds')
```


```{r}
length(prot_res$`AGC: 2E5`)
length(pep_res$`AGC: 2E5`)
```

```{r}
# code for limma plotting. Move into cell downstream for optional plotting!

notch_count %>%
      mutate(sample=remove_x(sample)) %>%
      filter(sample %in% colnames(dat)[extract_cols]) %>%
      group_by(!!sym(merge_col)) %>%
      summarise(mean_fraction_below=mean(fraction_below)) %>%
      merge(limma.results, by.x=merge_col, by.y='row.names')


    plot_title <- sprintf('%s - %s', name, contrasts2desc[[contrast]]) 
    p <- ggplot(limma.results) +
      ggtitle(plot_title)
    
    p1 <- p + aes(x = P.Value) + 
      geom_histogram(bins = 50, boundary = 0) + 
      theme_camprot() +
      facet_wrap(~species, scales='free')
    
    print(p1)
    print(p1 + aes(logFC))
    
    p2 <- p +
      aes(log10(P.Value), colour=contains_notch) +
      geom_density() +
      theme_camprot() +
      facet_wrap(~species)
    
    print(p2)
    
    p3 <- p +
      aes(mean_fraction_below, logFC) +
      geom_point() +
      theme_camprot() +
      facet_wrap(~species) +
      geom_smooth(method='lm')
    
    print(p3)
  
    p4 <- p + aes(logFC, colour=contains_notch) +
      geom_density() +
      facet_wrap(~species, scales='free') +
      theme_camprot() +
       xlab('Fold change (Log2)')
  
    if(!mock){
     p4 <- p4 + geom_vline(data=expected[
       expected$comparison==gsub('x', '', contrasts2desc[[contrast]]),],
                           aes(xintercept=log2(expected)), linetype=2)
   } else{
     p4 <- p4 + geom_vline(xintercept=0 ,linetype=2)
   }
    
    p5 <- limma.results %>%
      group_by(species, contains_notch, binned_ave_expr) %>%
      summarise(proportion_sig=mean(as.numeric(adj.P.Val<0.01))) %>%
      ggplot(aes(binned_ave_expr, proportion_sig, colour=contains_notch, group=contains_notch)) +
      geom_line() +
      theme_camprot(base_size=12) +
      facet_wrap(~species) +
      theme(axis.text.x=element_text(angle=45, vjust=1, hjust=1)) +
      xlab('Average abundance') +
      ylab('Propotion significant (1% FDR)') +
      ggtitle(plot_title)
```

Define a function to run limma, with option to run 'mock' or real differential abundance testing.
```{r}
run_limma <- function(obj,
                      mock=FALSE,
                      merge_col='Master.Protein.Accessions'){
  if(mock){
    # Treat the first 4 tags as duplicates for two conditions
    extract_cols <- 1:4
    spike <- factor(rep(c('a','b'), c(2,2)))
    contrasts <- 'spikeb'
  } else {
    extract_cols <- 1:10
    spike <- factor(rep(c(1,2,6), c(4,3,3)))
    contrasts <- c('spike2', 'spike6')
  }
  
  contrasts2desc <- c('Mock', '2x vs 1x', '6x vs 1x')
  names(contrasts2desc) <- c('spikeb', 'spike2', 'spike6')
  
  results <- vector('list', length(contrasts))
  names(results) <- unname(contrasts2desc[contrasts])
  
  study.design <- model.matrix(~ spike)
  
  dat <- exprs(obj)[,extract_cols] %>% log(base=2)
  
  fit <- lmFit(dat, study.design)
  fit <- eBayes(fit, trend=TRUE)

  for(contrast in contrasts){

    limma.results <- topTable(fit, coef = contrast, n = Inf, confint=TRUE)
    limma.results$sigma <- fit$sigma[rownames(limma.results)]

    limma.results <- limma.results %>%
      merge(fData(obj)[,'species',drop=FALSE], by='row.names') %>%
      filter(species!='mixed') %>%
      mutate(binned_ave_expr=Hmisc::cut2(AveExpr, g=8),
             comparison=contrasts2desc[[contrast]])
    
    results[[contrasts2desc[[contrast]]]] <- limma.results
  }
  
  results <- results %>% do.call(what='rbind')

  results
}

```

Run limma 'mock' over all datasets

```{r}

datasets <- list('protein'=prot_res, 'peptide'=pep_res)

all_mock_limma_results <- datasets %>% names() %>% lapply(function(l){
  
  datasets[[l]] %>% names() %>% lapply(function(a){
    
     datasets[[l]][[a]] %>% names() %>% lapply(function(t){
      
        obj <- datasets[[l]][[a]][[t]]$agg
        
        results <- run_limma(obj, mock=TRUE) %>%
          mutate(level=l, agc=a, threshold=t)
        
        results
      }) %>% do.call(what='rbind')
    }) %>% do.call(what='rbind')
  }) %>% do.call(what='rbind')
```

Run limma for all datasets
```{r}


all_limma_results <- datasets %>% names() %>% lapply(function(l){
  
  datasets[[l]] %>% names() %>% lapply(function(a){
    
     datasets[[l]][[a]] %>% names() %>% lapply(function(thresh){
      
        obj <- datasets[[l]][[a]][[thresh]]$agg
        results <- run_limma(obj) %>%
          mutate(level=l, agc=a, threshold=thresh)
        
        results
      }) %>% do.call(what='rbind')
    }) %>% do.call(what='rbind')
  }) %>% do.call(what='rbind')
```


```{r}
thresholds_to_retain <- all_limma_results %>%
      select(threshold) %>%
      unique() %>%
      separate(threshold, into=c('delta', 'interference', 'sn', 'notch'), sep=', ', remove=FALSE) %>%
      pull(threshold)
    
    
to_plot <- all_limma_results %>%
  filter(level=='protein', agc=='AGC: 2E5', threshold %in% thresholds_to_retain) %>%
  separate(threshold, into=c('delta', 'interference', 'sn', 'notch'), sep=', ', remove=FALSE) %>%
  mutate(notch=recode(notch, '1'='With notch filt', '0'='Without notch filt.'),
         sn=factor(sn, levels=c(0,10,100)),
         interference=factor(interference, levels=c(10, 50, 100)))

complete_feature_n <- to_plot %>% select(delta, interference, sn, notch) %>% unique() %>% nrow()

to_plot %>%
  group_by(Row.names) %>%
  tally() %>%
  pull(n) %>%
  table()

keep_features <- to_plot %>%
  group_by(Row.names) %>%
  tally() %>%
  filter(n==(complete_feature_n*2)) %>% # * 2 contrasts
  pull(Row.names)

print(length(keep_features))
print(to_plot %>%
  #filter(Row.names %in% keep_features) %>%
  #mutate(comparison=gsub('x', '', comparison)) %>%
  group_by(threshold, comparison, species, delta, interference, sn, notch, agc) %>%
  summarise(proportion_sig=mean(as.numeric(adj.P.Val<0.01), na.rm=TRUE),
            ave_lgfc=mean(logFC, na.rm=TRUE))) %>%
  ungroup() %>%
  select(delta, interference, sn, notch) %>% unique()
    
to_plot %>%
  filter(Row.names %in% keep_features) %>%
  mutate(comparison=gsub('x', '', comparison)) %>%
  filter(species=='S.cerevisiae', interference==10, delta==0.2, notch=='With notch filt') 
```
```{r}
complete_feature_n

to_plot %>%
  group_by(Row.names) %>%
  tally() %>% pull(n) %>% table()
```
```{r}
contains_notch <- psm_res %>% lapply(function(x){
  
  contains_notch_1_2 <- x[,1:7] %>%
    get_notch_per_protein() %>%
    group_by(Master.Protein.Accessions) %>%
    summarise(max_fraction=max(fraction_below)) %>%
    filter(max_fraction>0) %>%
    mutate(comparison='2 vs 1')
  
  contains_notch_1_6 <- x[,c(1:4, 8:10)] %>%
    get_notch_per_protein() %>%
    group_by(Master.Protein.Accessions) %>%
    summarise(max_fraction=max(fraction_below)) %>%
    filter(max_fraction>0) %>%
    mutate(comparison='6 vs 1')
  
  return(rbind(contains_notch_1_2, contains_notch_1_6))
})
```

```{r}
agcs <- unique(all_limma_results$agc)
names(agcs) <- agcs

levels <- unique(all_limma_results$level)
names(levels) <- levels

limma_filtering_sig_count_tile_plots <- agcs %>%
  lapply(function(a){
    levels %>%
    lapply(function(l) {
      
    thresholds_to_retain <- all_limma_results %>%
      select(threshold) %>%
      unique() %>%
      separate(threshold, into=c('delta', 'interference', 'sn', 'notch'), sep=', ', remove=FALSE) %>%
      filter(sn %in% c(0, 10)) %>%
      pull(threshold)

    to_plot <- all_limma_results %>%
      filter(level==l, agc==a, threshold %in% thresholds_to_retain) %>%
      separate(threshold, into=c('delta', 'interference', 'sn', 'notch'), sep=', ', remove=FALSE) %>%
      mutate(notch=recode(notch, '1'='With notch filt', '0'='Without notch filt.'),
             sn=factor(sn, levels=c(0,10,100)),
             interference=factor(interference, levels=c(10, 50, 100)))
    
    complete_feature_n <- to_plot %>% select(delta, interference, sn, notch) %>% unique() %>% nrow()
    
    to_plot %>%
      group_by(Row.names) %>%
      tally() %>%
      pull(n) %>%
      table()
    
    keep_features <- to_plot %>%
      group_by(Row.names) %>%
      tally() %>%
      filter(n==(complete_feature_n*2)) %>% # * 2 contrasts
      pull(Row.names)
    
    print(length(keep_features))

    summarised_common_features <- to_plot %>%
      filter(Row.names %in% keep_features) %>%
      mutate(comparison=gsub('x', '', comparison)) %>%
      group_by(threshold, comparison, species, delta, interference, sn, notch, agc) %>%
      summarise(proportion_sig=mean(as.numeric(adj.P.Val<0.01), na.rm=TRUE),
                ave_lgfc=mean(logFC, na.rm=TRUE))
    
    summarised_common_features_with_notch <- to_plot %>%
      filter(Row.names %in% keep_features) %>%
      mutate(comparison=gsub('x', '', comparison)) %>%
      merge(contains_notch[[a]],
            by.x=c('comparison', 'Row.names'),
            by.y=c('comparison', 'Master.Protein.Accessions')) %>%
      group_by(threshold, comparison, species, delta, interference, sn, notch, agc) %>%
      summarise(proportion_sig=mean(as.numeric(adj.P.Val<0.01), na.rm=TRUE),
                ave_lgfc=mean(logFC, na.rm=TRUE))
    
    print(to_plot %>%
      filter(Row.names %in% keep_features) %>%
      mutate(comparison=gsub('x', '', comparison)) %>%
      group_by(threshold, comparison, species, delta, interference, sn, notch, agc) %>%
            tally())
    
    
    print(to_plot %>%
      filter(Row.names %in% keep_features) %>%
      mutate(comparison=gsub('x', '', comparison)) %>%
        merge(contains_notch[[a]],
            by.x=c('comparison', 'Row.names'),
            by.y=c('comparison', 'Master.Protein.Accessions')) %>%
      group_by(threshold, comparison, species, delta, interference, sn, notch, agc) %>%
            tally())
      
    p <- summarised_common_features %>%
      ggplot(aes(y=interaction(interference, delta, sep=', '),
                 x=interaction(sn, notch, sep=', '),
                 fill=proportion_sig,
                 label=round(proportion_sig, 2))) +
      geom_tile() +
      theme_camprot(base_size=12) +
      facet_grid(comparison~species) +
      #ggtitle(sprintf('%s - %s', method, level)) +
      scale_fill_gradient2(mid='grey90', high=get_cat_palette(1),
                           low=get_cat_palette(2)[2],
                           midpoint=0.5,
                           name='Proportion significant\n(FDR<1%)') +
      ylab('Max interference (%), Min delta score') +
      xlab('Min Signal/Notch + Notch') +
      geom_text(size=3) +
      theme(panel.spacing = unit(0, "lines")) +
      scale_x_discrete(expand = c(0,0)) +
            scale_y_discrete(expand = c(0,0)) +
      theme(axis.text.x=element_text(angle=45, vjust=1, hjust=1)) +
      ggtitle(sprintf('%s - %s', a, l))
    
    print(p)
    
    p2 <- p + aes(fill=2^ave_lgfc, label=round(2^ave_lgfc, 2)) +
                    scale_fill_gradient2(mid='grey90', high=get_cat_palette(1),
                           low=get_cat_palette(2)[2],
                           midpoint=0.5,
                           name='Average fold-change')
    print(p2)
    
    print(p %+% summarised_common_features_with_notch)
    print(p2 %+% summarised_common_features_with_notch)
    
    p3 <- to_plot %>%
      mutate(comparison=gsub('x', '', comparison)) %>%
      group_by(threshold, comparison, species, delta, interference, sn, notch, agc) %>%
      summarise(n_sig=sum(as.numeric(adj.P.Val<0.01), na.rm=TRUE)) %>%
      ggplot(aes(y=interaction(interference, delta, sep=', '),
                 x=interaction(sn, notch, sep=', '),
                 fill=n_sig,
                 label=n_sig)) +
      geom_tile() +
      theme_camprot(base_size=12) +
      facet_grid(comparison~species) +
      scale_fill_gradient2(mid='grey90', high=get_cat_palette(1),
                           low=get_cat_palette(2)[2],
                           midpoint=0.5,
                           name='# significant (FDR<1%)') +
      ylab('Max interference (%), Min delta score') +
      xlab('Min Signal/Notch + Notch') +
      geom_text(size=3) +
      theme(panel.spacing = unit(0, "lines")) +
      scale_x_discrete(expand = c(0,0)) +
            scale_y_discrete(expand = c(0,0)) +
      theme(axis.text.x=element_text(angle=45, vjust=1, hjust=1)) +
      ggtitle(sprintf('%s - %s', a, l))
    
    print(p3)
    
    return(list('to_plot'=to_plot, 'keep_features'=keep_features, 'p'=p, 'p2'=p2, 'p3'=p3))
  })
})
```


```{r}
x <- limma_filtering_sig_count_tile_plots$`AGC: 5E4`$protein

x$to_plot %>%
  filter(sn==10, interference==10, delta==0.2) %>%
  ggplot(aes(logFC, colour=notch)) +
  geom_density() +
  theme_camprot() +
  facet_grid(species~comparison, scales='free')
```
```{r}
psm_res_flt <- readRDS('../results/psm_res_flt.rds')
```

```{r}
thresholds_of_interest <- c('0.2, 10, 10, 0')

contains_notch_filt <- psm_res_flt %>% lapply(function(agc){
  contains_notch <- vector('list', length(thresholds_of_interest))
  names(contains_notch) <- thresholds_of_interest
  for(threshold in thresholds_of_interest){

    contains_notch_1_2 <- agc[[threshold]][,1:7] %>%
      get_notch_per_protein() %>%
      group_by(Master.Protein.Accessions) %>%
      summarise(max_fraction=max(fraction_below)) %>%
      filter(max_fraction>0) %>%
      mutate(comparison='2 vs 1')
    
    contains_notch_1_6 <- agc[[threshold]][,c(1:4, 8:10)] %>%
      get_notch_per_protein() %>%
      group_by(Master.Protein.Accessions) %>%
      summarise(max_fraction=max(fraction_below)) %>%
      filter(max_fraction>0) %>%
      mutate(comparison='6 vs 1')

    contains_notch[[threshold]] <- rbind(contains_notch_1_2, contains_notch_1_6)
  }
  contains_notch
})
```


```{r}

limma_filtering_sig_count_tile_plots$`AGC: 5E4`$protein$to_plot %>%
  filter(interference==50, sn==0, delta==0.2) %>%
  mutate(comparison=gsub('x', '', comparison)) %>%
  merge(contains_notch_filt$`AGC: 5E4`$`0.2, 10, 10, 0`,
        by.x=c('comparison', 'Row.names'),
        by.y=c('comparison', 'Master.Protein.Accessions')) %>%
  select(species, logFC, notch, interference, sn, comparison, Row.names) %>%
  ggplot(aes(logFC)) +
  geom_histogram() +
  theme_camprot(base_size=15) +
  facet_grid(cols=(vars(species, comparison)), rows=vars(notch), scales='free') +
  geom_vline(data=expected[expected$comparison %in% c('2 vs 1', '6 vs 1'),],
             aes(xintercept=log2(expected)), linetype=2, colour=get_cat_palette(1))
  

```






code for DEqMS if required...
```{r}
feature_count <- prot_robust$`filtered, inc S/N`$`AGC: 5E4`$feature_counts %>%
  filter(sample %in% colnames(dat))

# Get the minimum peptide count per protein
min.pep.count <- feature_count %>% 
  group_by(Master.Protein.Accessions) %>% 
  summarise(Min.pep.count = min(n)) %>% 
  tibble::column_to_rownames("Master.Protein.Accessions")
  
# Add the min peptide count
fit$count = min.pep.count[rownames(fit$coefficients), "Min.pep.count"]

# Run DEqMS
fit.deqms = spectraCounteBayes(fit)

# Run the DEqMS giagnostic plots
VarianceBoxplot(fit.deqms, n = 30, xlab = "PSM count")
VarianceScatterplot(fit.deqms)

# Extract the DEqMS results
DEqMS.results <- outputResult(fit.deqms, coef_col = 2)

```