---
title: "Parse peptides"
author:
  - name: "Tom Smith"
    affiliation: "Cambridge Centre for Proteomics"
date: "`r format(Sys.time(), '%d %B, %Y')`"
abstract: | 
  Here, we parse the peptide-level output from
  https://www.mcponline.org/content/19/10/1706
  and inspect the notch.
output:
  pdf_document:
  html_notebook: default
geometry: margin=1in
fontfamily: mathpazo
fontsize: 11pt
---

Load libraries
```{r setup, message=FALSE}

#### Load packages ####
library(camprotR)
library(ggplot2)
library(tidyverse)
library(MSnbase)
```

Read in PSM data
```{r}
psm <- read.delim('../../raw/external/161117_SILAC_HeLa_UPS1_TMT10_5Mixtures_3TechRep_UPSdB_Multiconsensus_PD22_Intensity_03_with_FDR_control_PSMs.txt')
```


Make the cRAP list for filtering
```{r}
# Load the cRAP FASTA used for the PD search
crap.fasta <- Biostrings::fasta.index(
  "../../shared_files/cRAP_FullIdentifiers.fasta",
  seqtype = "AA"
)

# Extract the non cRAP UniProt accessions associated with each cRAP protein
crap.accessions <- crap.fasta %>% 
  pull(desc) %>% 
  stringr::str_extract_all("(?<=\\|).*?(?=\\|)") %>% 
  unlist()

```

Parse and filter PSMs to remove cRAP proteins
```{r}
psm_parsed <- parse_features(psm, TMT=TRUE, level='PSM', crap_proteins=crap.accessions, unique_master=FALSE)
```
Make MSnSet
```{r}
# Abundance columns for TMT PD-output start with Abundance 
abundance_cols <- colnames(psm_parsed)[grepl('Abundance.', colnames(psm_parsed))]

.e <- as.matrix(psm_parsed[,abundance_cols])
.f <- psm_parsed[,setdiff(colnames(psm_parsed), abundance_cols)]

# update the column names to remove the 'Abundance.` prefix
colnames(.e) <- gsub('Abundance.', '', colnames(.e))

# we don't have 'phenotype' data to add so we just define the 'expression' data and 'feature' data
psm_res <- MSnbase::MSnSet(exprs=.e, fData=.f)
```


Plotting the notch. Note that they state in the methods: "Orbitrap with a resolution of 60k, scan range of m/z 100 to 500, an AGC target of 5E4, and a maximum IT of 105 ms." and 'Reporter ions intensities were used to express abundances'. Hence, we expect very little notch and the position of the notch will not be where it is for S:N as readout. 
```{r}

for(sfile in unique(fData(psm_res)$Spectrum.File)){
  p <- plot_TMT_notch(psm_res[fData(psm_res)$Spectrum.File==sfile,],
                      notch_lower=2^9.25, notch_upper=2^9.75) +
    ggtitle(gsub('161117_SILAC_HeLa_UPS1_TMT10_', '', sfile))
  
  print(p)
}

```


OK, with their high AGC, <1% of PSM intensities fall below the notch.






