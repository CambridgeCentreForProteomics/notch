---
title: 'Aggregate to protein'
author:
  - name: "Tom Smith"
    affiliation: "Cambridge Centre for Proteomics"
date: "`r format(Sys.time(), '%d %B, %Y')`"
abstract: | 
  Here, aggregate the PSM-level abundances to protein-level and re-inspect the
  fold changes
output:
  pdf_document:
  html_notebook: default
geometry: margin=1in
fontfamily: mathpazo
fontsize: 11pt
---

Load libraries
```{r setup, message=FALSE}

#### Load packages ####
library(camprotR)
library(ggplot2)
library(tidyverse)
library(MSnbase)
```

Read in PSM-level quant and expected fold changes
```{r}
psm_res <- readRDS('../results/psm_res.rds')
psm_res_flt <- readRDS('../results/psm_res_flt.rds')
psm_res_flt_sn <- readRDS('../results/psm_res_flt_sn.rds')
expected <- readRDS('../results/expected.rds')
```

Create a list of PSM datasets
```{r}
psm_datasets <- list('unfiltered'=psm_res, 'filtered'=psm_res_flt, 'filtered, inc S/N'=psm_res_flt_sn)
```


Function to aggregate from PSM to protein by 'sum' or 'robust'
```{r}
aggregate_to_protein <- function(psm, method='robust'){
  
  if(!method %in% c('robust', 'sum')){
    stop('method must be robust or sum')
  }
  
  # Method-dependent filtering & transformation of PSMs
  if(method=='sum'){
    psm_filt <- psm %>% 
      MSnbase::filterNA(pNA = 0) %>% # remove PSMs with missing values 
      restrict_features_per_protein(min_features = 2) # remove proteins with <2 PSMs
    
    prot_group <- MSnbase::fData(psm_filt)$Master.Protein.Accessions
    
    protein <- psm_filt %>%
      MSnbase::combineFeatures(groupBy = prot_group, method = 'sum')
        
  } else{
    # Robust requires log-transformed abundances.
    # Thus, we log, summarise and then exponentiate the protein-level abundances
    
    psm_filt <- psm %>% 
      MSnbase::filterNA(pNA = 0.2) %>% # remove PSMs with >20% missing values
      restrict_features_per_protein(min_features = 2) %>% # remove proteins with <2 PSMs 
      log(base=2)
    
    prot_group <- MSnbase::fData(psm_filt)$Master.Protein.Accessions
    
    protein <- psm_filt %>%
      MSnbase::combineFeatures(groupBy = prot_group, method = 'robust', maxit = 1000)
    Biobase::exprs(protein) <- 2^Biobase::exprs(protein)
  }
  
  feature_counts <- count_features_per_protein(psm_filt)
  
  return(list('protein'=protein, 'feature_counts'=feature_counts))
}
```

Aggregate using sum
```{r}
prot_sum <- psm_datasets %>% lapply(function(psm_dataset){
  psm_dataset %>% lapply(function(agc_target){
    x <- agc_target %>% log(base=2) %>% MSnbase::normalise(method='diff.median')
    exprs(x) <- 2^exprs(x)
    aggregate_to_protein(x,  method='sum')
  })
})

```

How many proteins per PSM filtering and AGC target when using sum summarisation
```{r}
prot_sum %>% lapply(function(x) lapply(x, function(y) dim(y$protein)))
```

Aggregate using robust
```{r}
prot_robust <- psm_datasets %>% lapply(function(psm_dataset){
  psm_dataset %>% lapply(function(agc_target){
    x <- agc_target %>% log(base=2) %>% MSnbase::normalise(method='diff.median')
    exprs(x) <- 2^exprs(x)
    aggregate_to_protein(x,  method='robust')
  })
})
```

How many proteins per PSM filtering and AGC target when using sum summarisation
```{r}
prot_robust %>% lapply(function(x) lapply(x, function(y) dim(y$protein)))
```

Get fold changes for sum and robust-summarised protein abundances.
```{r}
source('./R/get_quant_vs_mean.R')

quant_vs_mean_prot_sum <- prot_sum %>% lapply(function(x){
  lapply(x, function(y) get_quant_vs_mean(y$protein))
}) 


quant_vs_mean_prot_robust <- prot_robust %>% lapply(function(x){
  lapply(x, function(y) get_quant_vs_mean(y$protein))
}) 
```

```{r}
notch_per_protein <- psm_datasets %>% lapply(function(psm_dataset){
  psm_dataset %>% lapply(get_notch_per_protein)
  })
```     

```{r}
summarisations <- list('sum'=quant_vs_mean_prot_sum, 'robust'=quant_vs_mean_prot_robust)
```

```{r}
summarisations %>% names() %>% lapply(function(method){
    
  summarisations[[method]] %>% names() %>% lapply(function(flt){
    
    summarisations[[method]][[flt]] %>% names() %>% lapply(function(agc){
    
      x <- summarisations[[method]][[flt]][[agc]]
      y <- notch_per_protein[[flt]][[agc]] %>% mutate(sample=remove_x(sample))
      
      to_plot <- merge(x, y,
                       by.x=c('id', 'tag'),
                       by.y=c('Master.Protein.Accessions', 'sample')) %>%
        filter(species!='mixed')
        
      p <- to_plot  %>%
        ggplot(aes(log2(intensity), diff)) +
          theme_camprot(base_size=12) +
          facet_grid(species~comparison) +
          geom_hline(aes(yintercept=log2(expected)),
                     data=expected,
                     colour='black', linetype=2) +
          xlab('Protein abundance (log2)') +
          ylab('Difference in abundnace (log2)') +
          ggtitle(sprintf('%s - %s - %s', agc, flt, method))
    
      suppressWarnings(print(p + geom_point(size=0.2, alpha=0.1, colour='grey30')))
    
      suppressWarnings(print(p %+% to_plot[to_plot$fraction_below>0,] +
              aes(fraction_below) +
              geom_point(size=0.5, alpha=0.5) +
              geom_smooth() +
              xlab('Fraction PSMs below notch')))
      return(NULL)
      
    })
    
    return(NULL)
  
  })
  
  return(NULL)
})
```



```{r}
saveRDS(prot_sum, '../results/prot_sum.rds')
saveRDS(prot_robust, '../results/prot_robust.rds')
saveRDS(notch_per_protein, '../results/notch_per_protein.rds')
```

